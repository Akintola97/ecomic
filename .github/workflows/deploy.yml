name: Deploy Ecomic App (Next.js + PM2)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest

    # All `run:` steps will by default execute in ./e-commerce
    defaults:
      run:
        working-directory: ./e-commerce

    steps:
      # 1) Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Setup Node.js 20
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3) Create .env from APP_ENV (for the CI build)
      - name: Create .env from APP_ENV
        env:
          APP_ENV: ${{ secrets.APP_ENV }}
        run: |
          printf '%s\n' "$APP_ENV" > .env

      # 4) Install dependencies (in ./e-commerce)
      - name: Install dependencies
        run: npm ci

      # 5) Build Next.js app (load env first)
      - name: Build Next.js app
        run: |
          set -o allexport
          source .env
          set +o allexport

          npm run build

      # 6) Setup SSH key for VPS access
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # 7) Ensure the app directory exists on the VPS
      - name: Ensure app directory exists on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
        run: |
          ssh -i ~/.ssh/id_ed25519 "$VPS_USER@$VPS_HOST" "mkdir -p '$VPS_APP_DIR'"

      # 8) Upload built project to VPS using rsync
      - name: Upload project to VPS (rsync)
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
        run: |
          rsync -az --delete \
            --exclude ".env" \
            -e "ssh -i ~/.ssh/id_ed25519" \
            ./ "$VPS_USER@$VPS_HOST:$VPS_APP_DIR"

      # 9) On VPS: write .env, install deps, build, restart PM2
      - name: Install & Restart PM2 on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_APP_DIR: ${{ secrets.VPS_APP_DIR }}
          PM2_APP_NAME: ${{ secrets.PM2_APP_NAME }}
          APP_ENV: ${{ secrets.APP_ENV }}
        run: |
          ssh -i ~/.ssh/id_ed25519 "$VPS_USER@$VPS_HOST" "
            set -e
            cd '$VPS_APP_DIR'

            # Write .env from APP_ENV secret
            printf '%s\n' \"$APP_ENV\" > .env

            # Install dependencies and rebuild on the VPS
            npm ci
            npm run build

            # Restart (or start) PM2 app
            pm2 restart '$PM2_APP_NAME' || pm2 start npm --name '$PM2_APP_NAME' -- start

            pm2 save
          "
